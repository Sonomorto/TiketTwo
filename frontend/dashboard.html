<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventHub - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <h1 class="logo">🎟️ EventHub</h1>
            <div class="nav-links">
                <a href="/" class="nav-item">Home</a>
                <a href="/create-event.html" class="nav-item" id="createEventLink">Crea Evento</a>
                <span class="user-greeting" id="userGreeting"></span>
                <button class="btn-logout" id="btnLogout">Logout</button>
            </div>
        </nav>
    </header>

    <main class="dashboard-container">
        <!-- Sezione Organizzatore -->
        <section class="dashboard-section" id="organizerSection">
            <h2>I Tuoi Eventi</h2>
            <div class="events-list" id="organizerEvents">
                <div class="loader">Caricamento eventi...</div>
            </div>
        </section>

        <!-- Sezione Utente -->
        <section class="dashboard-section">
            <h2>I Tuoi Biglietti</h2>
            <div class="tickets-list" id="userTickets">
                <div class="loader">Caricamento biglietti...</div>
            </div>
        </section>
    </main>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/v1';
        const token = localStorage.getItem('token');
        let isOrganizer = false;

        // Controllo autenticazione
        if(!token) {
            window.location.href = '/auth.html?redirect=/dashboard.html';
        }

        // Carica dati utente
        const loadUserData = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const user = await response.json();
                isOrganizer = user.role === 'organizer';
                document.getElementById('userGreeting').textContent = `Ciao, ${user.name}`;
                document.getElementById('createEventLink').style.display = isOrganizer ? 'block' : 'none';
                
                // Carica contenuti in base al ruolo
                if(isOrganizer) loadOrganizerEvents();
                loadUserTickets();
                
            } catch (error) {
                console.error('Errore nel caricamento dati utente:', error);
            }
        };

        // Carica eventi organizzatore
        const loadOrganizerEvents = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/events?organizer=true`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const events = await response.json();
                renderOrganizerEvents(events);
            } catch (error) {
                document.getElementById('organizerEvents').innerHTML = `
                    <div class="error">❌ Errore nel caricamento eventi: ${error.message}</div>
                `;
            }
        };

        // Render eventi organizzatore
        const renderOrganizerEvents = (events) => {
            const container = document.getElementById('organizerEvents');
            container.innerHTML = events.length > 0 
                ? events.map(event => `
                    <div class="event-item">
                        <div class="event-info">
                            <h3>${event.title}</h3>
                            <p>📅 ${new Date(event.date).toLocaleDateString()}</p>
                            <p>🎫 Biglietti venduti: ${event.ticketsSold || 0}/${event.capacity}</p>
                        </div>
                        <div class="event-actions">
                            <button class="btn-edit" data-id="${event._id}">Modifica</button>
                            <button class="btn-delete" data-id="${event._id}">Elimina</button>
                        </div>
                    </div>
                `).join('')
                : '<div class="empty">Nessun evento creato</div>';

            // Aggiungi event listeners per azioni
            container.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    window.location.href = `/create-event.html?id=${e.target.dataset.id}`;
                });
            });

            container.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if(confirm('Sei sicuro di voler eliminare questo evento?')) {
                        try {
                            await fetch(`${API_BASE_URL}/events/${e.target.dataset.id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            loadOrganizerEvents();
                        } catch (error) {
                            alert('Errore nell\'eliminazione: ' + error.message);
                        }
                    }
                });
            });
        };

        // Carica biglietti utente
        const loadUserTickets = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/tickets`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const tickets = await response.json();
                renderUserTickets(tickets);
            } catch (error) {
                document.getElementById('userTickets').innerHTML = `
                    <div class="error">❌ Errore nel caricamento biglietti: ${error.message}</div>
                `;
            }
        };

        // Render biglietti utente
        const renderUserTickets = (tickets) => {
            const container = document.getElementById('userTickets');
            container.innerHTML = tickets.length > 0 
                ? tickets.map(ticket => `
                    <div class="ticket-item">
                        <div class="ticket-info">
                            <h3>${ticket.event.title}</h3>
                            <p>📅 ${new Date(ticket.event.date).toLocaleDateString()}</p>
                            <p>🎫 Quantità: ${ticket.quantity}</p>
                            <p>💰 Totale: €${(ticket.quantity * ticket.event.price).toFixed(2)}</p>
                        </div>
                        <button class="btn-cancel" data-id="${ticket._id}">Annulla</button>
                    </div>
                `).join('')
                : '<div class="empty">Nessun biglietto acquistato</div>';

            // Gestione annullamento biglietti
            container.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if(confirm('Annullare questa prenotazione?')) {
                        try {
                            await fetch(`${API_BASE_URL}/tickets/${e.target.dataset.id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            loadUserTickets();
                        } catch (error) {
                            alert('Errore nell\'annullamento: ' + error.message);
                        }
                    }
                });
            });
        };

        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/';
        });

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', loadUserData);
    </script>
</body>
</html>