<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventHub - Notifiche</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <h1 class="logo">üéüÔ∏è EventHub</h1>
            <div class="nav-links">
                <a href="/" class="nav-item">Home</a>
                <a href="/dashboard.html" class="nav-item">Dashboard</a>
                <span class="user-greeting" id="userGreeting"></span>
                <button class="btn-logout" id="btnLogout">Logout</button>
            </div>
        </nav>
    </header>

    <main class="notifications-container">
        <div class="notifications-header">
            <h2>Le tue notifiche</h2>
            <button class="btn-mark-all" id="markAllRead">Segna tutte come lette</button>
        </div>

        <div class="notifications-list" id="notificationsList">
            <div class="loader">Caricamento notifiche...</div>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/v1';
        const token = localStorage.getItem('token');

        // Controllo autenticazione
        if(!token) {
            window.location.href = '/auth.html?redirect=/notifications.html';
        }

        // Formatta data notifica
        const formatNotificationDate = (dateString) => {
            const options = { 
                hour: '2-digit', 
                minute: '2-digit', 
                day: '2-digit', 
                month: 'long' 
            };
            return new Date(dateString).toLocaleDateString('it-IT', options);
        };

        // Carica notifiche
        const loadNotifications = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const notifications = await response.json();
                renderNotifications(notifications);
            } catch (error) {
                document.getElementById('notificationsList').innerHTML = `
                    <div class="error">‚ùå Errore nel caricamento: ${error.message}</div>
                `;
            }
        };

        // Render notifiche
        const renderNotifications = (notifications) => {
            const container = document.getElementById('notificationsList');
            
            if(notifications.length === 0) {
                container.innerHTML = '<div class="empty">Nessuna notifica da visualizzare</div>';
                return;
            }

            container.innerHTML = notifications.map(notification => `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" data-id="${notification._id}">
                    <div class="notification-icon">üîî</div>
                    <div class="notification-content">
                        <h3 class="notification-title">${notification.title}</h3>
                        <p class="notification-message">${notification.message}</p>
                        <p class="notification-time">${formatNotificationDate(notification.createdAt)}</p>
                    </div>
                    ${!notification.read ? 
                        `<button class="btn-mark-read" data-id="${notification._id}">Segna come letto</button>` : 
                        '<span class="read-badge">Letta</span>'
                    }
                </div>
            `).join('');

            // Aggiungi event listeners per segnare come lette
            container.querySelectorAll('.btn-mark-read').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    await markNotificationAsRead(e.target.dataset.id);
                    e.target.parentElement.classList.add('read');
                    e.target.remove();
                });
            });
        };

        // Segna notifica come letta
        const markNotificationAsRead = async (notificationId) => {
            try {
                await fetch(`${API_BASE_URL}/notifications/${notificationId}/mark-read`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.error('Errore:', error);
            }
        };

        // Segna tutte come lette
        document.getElementById('markAllRead').addEventListener('click', async () => {
            try {
                await fetch(`${API_BASE_URL}/notifications/mark-all-read`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadNotifications();
            } catch (error) {
                console.error('Errore:', error);
            }
        });

        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/';
        });

        // Polling per aggiornamenti ogni 30 secondi
        setInterval(loadNotifications, 30000);

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', loadNotifications);
    </script>
</body>
</html>