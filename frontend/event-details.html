<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventHub - Dettagli Evento</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <h1 class="logo">üéüÔ∏è EventHub</h1>
            <div class="nav-links">
                <a href="/" class="nav-item">Home</a>
                <a href="/dashboard.html" class="nav-item">Dashboard</a>
                <span class="user-greeting" id="userGreeting"></span>
            </div>
        </nav>
    </header>

    <main class="event-details-container">
        <section class="event-main-info">
            <img src="" alt="Immagine evento" class="event-cover" id="eventImage">
            <div class="event-header">
                <h1 id="eventTitle"></h1>
                <div class="event-meta">
                    <span class="event-date" id="eventDate"></span>
                    <span class="event-location" id="eventLocation"></span>
                    <span class="event-category" id="eventCategory"></span>
                </div>
                <div class="event-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="availableTickets"></span>
                        <span class="stat-label">Biglietti disponibili</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="eventPrice"></span>
                        <span class="stat-label">Prezzo biglietto</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="event-description">
            <h2>Descrizione dell'evento</h2>
            <p id="eventDescription"></p>
        </section>

        <section class="ticket-section" id="ticketSection">
            <h2>Acquista Biglietti</h2>
            <form id="ticketForm">
                <div class="form-group">
                    <label for="ticketQuantity">Quantit√†:</label>
                    <input type="number" id="ticketQuantity" min="1" value="1" required>
                </div>
                <button type="submit" class="btn-buy">Acquista ora</button>
            </form>
            <div id="purchaseMessage" class="message"></div>
        </section>
    </main>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/v1';
        const eventId = new URLSearchParams(window.location.search).get('id');
        const token = localStorage.getItem('token');

        // Controllo autenticazione
        if(!token) {
            window.location.href = '/auth.html?redirect=' + encodeURIComponent(window.location.pathname + '?id=' + eventId);
        }

        // Carica dettagli evento
        const loadEventDetails = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/events/${eventId}`);
                if(!response.ok) throw new Error('Evento non trovato');
                
                const event = await response.json();
                populateEventData(event);
            } catch (error) {
                document.querySelector('.event-details-container').innerHTML = `
                    <div class="error">${error.message}</div>
                `;
            }
        };

        // Popola dati evento
        const populateEventData = (event) => {
            document.getElementById('eventTitle').textContent = event.title;
            document.getElementById('eventDescription').textContent = event.description;
            document.getElementById('eventDate').textContent = new Date(event.date).toLocaleDateString('it-IT', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('eventLocation').textContent = `üìç ${event.location}`;
            document.getElementById('eventCategory').textContent = `üè∑Ô∏è ${event.category}`;
            document.getElementById('availableTickets').textContent = event.availableTickets;
            document.getElementById('eventPrice').textContent = `‚Ç¨${event.price?.toFixed(2) || '0.00'}`;
            document.getElementById('eventImage').src = event.image || 'placeholder.jpg';

            // Disabilita acquisto se non ci sono biglietti
            if(event.availableTickets <= 0) {
                document.getElementById('ticketForm').innerHTML = `
                    <div class="alert">‚ö†Ô∏è Biglietti esauriti</div>
                `;
            }
        };

        // Acquisto biglietti
        document.getElementById('ticketForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const quantity = parseInt(document.getElementById('ticketQuantity').value);

            try {
                const response = await fetch(`${API_BASE_URL}/tickets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        eventId,
                        quantity
                    })
                });

                const data = await response.json();
                
                if(!response.ok) throw new Error(data.message || 'Errore nell\'acquisto');

                // Aggiorna UI
                document.getElementById('availableTickets').textContent = 
                    parseInt(document.getElementById('availableTickets').textContent) - quantity;
                
                document.getElementById('purchaseMessage').innerHTML = `
                    <div class="success">‚úÖ Acquisto effettuato! Controlla la tua email e la dashboard.</div>
                `;
                
                // Resetta il form
                document.getElementById('ticketQuantity').value = 1;

            } catch (error) {
                document.getElementById('purchaseMessage').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        });

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            if(!eventId) window.location.href = '/';
            loadEventDetails();
        });
    </script>
</body>
</html>